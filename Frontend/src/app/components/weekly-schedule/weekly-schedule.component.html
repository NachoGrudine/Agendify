﻿<div class="schedule-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-left">
      <div class="header-icon">
        <i-lucide [img]="ClockIcon" [size]="32"></i-lucide>
      </div>
      <div class="header-title-section">
        <h1>Mis Horarios</h1>
        <p class="subtitle">Configura tu disponibilidad semanal</p>
      </div>
    </div>
  </div>

  <!-- Header -->
  <div class="schedule-header">
    <div class="header-content">
      <div class="title-wrapper">
        @if (hasUnsavedChanges()) {
          <span class="unsaved-badge">Cambios sin guardar</span>
        }
      </div>
      <p class="header-subtitle">Estos horarios se reflejarán en tu calendario público.</p>
    </div>
    <div class="header-actions">
      @if (hasUnsavedChanges()) {
        <app-button
          label="Descartar"
          severity="outlined"
          [iconStart]="XIcon"
          customClass="btn-discard"
          (onClick)="discardChanges()"
        />
      }
      <app-button
        label="Guardar Cambios"
        severity="primary"
        [iconStart]="SaveIcon"
        [loading]="isSaving()"
        [disabled]="isSaving() || hasValidationErrors() || !hasUnsavedChanges()"
        (onClick)="saveChanges()"
      />
    </div>
  </div>

  <!-- Messages -->
  @if (successMessage()) {
    <div class="alert alert-success">
      <i-lucide [img]="CheckCircleIcon" [size]="20"></i-lucide>
      <span>{{ successMessage() }}</span>
    </div>
  }

  @if (errorMessage()) {
    <div class="alert alert-error">
      <i-lucide [img]="XCircleIcon" [size]="20"></i-lucide>
      <span>{{ errorMessage() }}</span>
    </div>
  }

  <!-- Loading State -->
  @if (isLoading()) {
    <app-loading-spinner message="Cargando horarios..." />
  } @else {
    <!-- Schedule Grid - 2 Columnas Compactas -->
    <div class="schedule-grid">
      @for (day of weekSchedule(); track day.dayOfWeek; let dayIndex = $index) {
        <app-card>
          <!-- Card Header Compacto con Toggle Inline -->
          <div class="day-header" (click)="toggleDay(dayIndex)">
            <div class="day-header-left">
              <label class="toggle-switch-compact">
                <input
                  type="checkbox"
                  [checked]="day.isOpen"
                  (change)="toggleDay(dayIndex)"
                  class="toggle-input"
                />
                <span class="toggle-slider-compact"></span>
              </label>
              <span class="day-name">{{ day.dayName }}</span>
            </div>

            <button
              type="button"
              class="btn-copy-compact"
              (click)="$event.stopPropagation(); copyToAll(dayIndex)"
              [disabled]="!day.isOpen"
              title="Copiar al resto"
            >
              <i-lucide [img]="CopyIcon" [size]="14"></i-lucide>
            </button>
          </div>

          <!-- Card Content Compacto -->
          @if (day.isOpen) {
            <div class="day-content">
              @for (slot of day.slots; track $index; let slotIndex = $index) {
                <div class="slot-inline">
                  <input
                    type="time"
                    [value]="slot.start"
                    (change)="updateSlot(dayIndex, slotIndex, 'start', $any($event.target).value)"
                    class="time-input-compact"
                    [class.input-error]="!isValidTimeRange(slot)"
                  />
                  <span class="separator">-</span>
                  <input
                    type="time"
                    [value]="slot.end"
                    (change)="updateSlot(dayIndex, slotIndex, 'end', $any($event.target).value)"
                    class="time-input-compact"
                    [class.input-error]="!isValidTimeRange(slot)"
                  />
                  <button
                    type="button"
                    class="btn-icon-compact"
                    (click)="removeSlot(dayIndex, slotIndex)"
                    title="Eliminar"
                  >
                    <i-lucide [img]="TrashIcon" [size]="14"></i-lucide>
                  </button>
                </div>
                @if (!isValidTimeRange(slot)) {
                  <span class="error-mini">⚠️ Hora inválida</span>
                }
              }

              <button
                type="button"
                class="btn-add-compact"
                (click)="addSlot(dayIndex)"
              >
                <i-lucide [img]="PlusIcon" [size]="12"></i-lucide>
                Agregar corte
              </button>
            </div>
          } @else {
            <div class="day-closed-label">Cerrado</div>
          }
        </app-card>
      }
    </div>

    <!-- Footer Info -->
    <div class="schedule-footer">
      <div class="footer-note">
        <i-lucide [img]="InfoIcon" [size]="18" class="note-icon"></i-lucide>
        <p>Los cambios no se aplicarán hasta que presiones "Guardar Cambios".</p>
      </div>
    </div>
  }
</div>
