<!-- Header con Icono + Fecha -->
<div class="modal-header">
  <div class="header-left">
    <app-section-icon [icon]="modalIcon()" [size]="24" />
    <div>
      <h2 class="modal-title">{{ modalTitle() }}</h2>
      <p class="modal-subtitle">{{ formattedSelectedDate }}</p>
    </div>
  </div>
  <app-button
    severity="outlined"
    [iconStart]="XIcon"
    [iconSize]="20"
    customClass="btn-icon-close"
    (onClick)="onCancel()"
  />
</div>

<form [formGroup]="appointmentForm" (ngSubmit)="onSubmit()" class="modal-body">

      <!-- PROFESIONAL (si hay múltiples) -->
      @if (showProviderField()) {
        <div class="form-section">
          <app-dropdown
            label="PROFESIONAL"
            formControlName="providerId"
            [options]="providers()"
            optionLabel="name"
            optionValue="id"
            placeholder="Seleccionar profesional..."
            [filter]="true"
            filterPlaceholder="Buscar profesional..."
            (onChange)="onProviderChange($event)"
          >
            <ng-template let-provider pTemplate="item">
              {{ provider.name }} - {{ provider.specialty }}
            </ng-template>
          </app-dropdown>
        </div>
      }

      <!-- CLIENTE -->
      <div class="form-section">
        <div class="form-field">
          <app-input
            label="CLIENTE"
            formControlName="customerSearch"
            placeholder="Buscar cliente..."
            [iconStart]="UserIcon"
            [iconSize]="18"
          />
          @if (showCustomerDropdown() && filteredCustomers().length > 0) {
            <div class="dropdown-results">
              @for (customer of filteredCustomers(); track customer.id) {
                <button type="button" class="dropdown-item" (click)="selectCustomer(customer)">
                  <strong>{{ customer.name }}</strong>
                  @if (customer.phone || customer.email) {
                    <span class="item-meta">{{ customer.phone || customer.email }}</span>
                  }
                </button>
              }
            </div>
          }
        </div>
      </div>

      <!-- SERVICIO -->
      <div class="form-section">
        <div class="form-field">
          <app-input
            label="SERVICIO"
            formControlName="serviceSearch"
            placeholder="Buscar servicio..."
            [iconStart]="BriefcaseIcon"
            [iconSize]="18"
          />
          @if (showServiceDropdown() && filteredServices().length > 0) {
            <div class="dropdown-results">
              @for (service of filteredServices(); track service.id) {
                <button type="button" class="dropdown-item" (click)="selectService(service)">
                  <strong>{{ service.name }}</strong>
                  <span class="item-meta">{{ service.defaultDuration }} min @if (service.price) {· ${{ service.price }}}</span>
                </button>
              }
            </div>
          }
        </div>
      </div>

      <!-- HORARIO - SIMPLIFICADO -->
      <div class="form-section">
        <label class="section-label">
          <i-lucide [img]="ClockIcon" [size]="18" class="label-icon"></i-lucide>
          HORARIO DEL TURNO
        </label>

        <div class="time-inputs-row">
          <div class="time-input-group">
            <label class="input-label">Desde</label>
            <input
              type="time"
              formControlName="startTime"
              class="time-input"
              step="900"
            />
          </div>

          <div class="time-separator">→</div>

          <div class="time-input-group">
            <label class="input-label">Hasta</label>
            <input
              type="time"
              formControlName="endTime"
              class="time-input"
              step="900"
            />
          </div>
        </div>

        <!-- Duración calculada -->
        @if (appointmentForm.get('startTime')?.value && appointmentForm.get('endTime')?.value) {
          <div class="duration-display">
            <span class="duration-label">Duración:</span>
            <span class="duration-value">{{ getCalculatedDuration() }}</span>
          </div>
        }
      </div>

      <!-- NOTAS -->
      <div class="form-section">
        <app-textarea
          label="NOTAS INTERNAS"
          formControlName="notes"
          [rows]="3"
          placeholder="Detalles adicionales del turno..."
        />
      </div>

      <!-- ALERTAS -->
      @if (errorMessage()) {
        <div class="alert alert-error">
          <i-lucide [img]="AlertCircleIcon" [size]="20"></i-lucide>
          <div class="alert-content">
            <strong>Error</strong>
            <p>{{ errorMessage() }}</p>
          </div>
        </div>
      }
      @if (successMessage()) {
        <div class="alert alert-success">
          <i-lucide [img]="CheckCircleIcon" [size]="20"></i-lucide>
          <div class="alert-content">
            <strong>¡Éxito!</strong>
            <p>{{ successMessage() }}</p>
          </div>
        </div>
      }

      <!-- FOOTER DENTRO DEL FORM -->
      <div class="modal-footer">
        <app-button
          type="button"
          label="Cancelar"
          severity="outlined"
          (onClick)="onCancel()"
        />
        <div class="footer-actions">
          <app-button
            type="button"
            label="Limpiar"
            severity="secondary"
            (onClick)="appointmentForm.reset()"
          />
          <app-button
            type="submit"
            [label]="submitButtonLabel()"
            severity="primary"
            [loading]="isSaving()"
            [disabled]="isSaving() || !appointmentForm.valid"
          />
        </div>
    </div>

  </form>

  <!-- Loading Overlay -->
  @if (isLoading()) {
    <app-loading-spinner [overlay]="true" message="Cargando datos..." />
  }
