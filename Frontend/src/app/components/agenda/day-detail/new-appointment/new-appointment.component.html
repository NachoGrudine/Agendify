﻿<div class="modal-overlay">
  <app-card customClass="modal-card">
    <!-- Header con Fecha -->
    <div class="modal-header">
      <div>
        <h2 class="modal-title">Nuevo Turno</h2>
        <p class="modal-subtitle">{{ formattedSelectedDate }}</p>
      </div>
      <app-button
        severity="outlined"
        [iconStart]="XIcon"
        [iconSize]="20"
        customClass="btn-icon-close"
        (onClick)="onCancel()"
      />
    </div>

    <form [formGroup]="appointmentForm" (ngSubmit)="onSubmit()" class="modal-body">

      <!-- Provider (si hay múltiples) -->
      @if (showProviderField()) {
        <app-dropdown
          label="PROFESIONAL"
          formControlName="providerId"
          [options]="providers()"
          optionLabel="name"
          optionValue="id"
          placeholder="Seleccionar profesional..."
          [filter]="true"
          filterPlaceholder="Buscar profesional..."
          (onChange)="onProviderChange($event)"
        >
          <ng-template let-provider pTemplate="item">
            {{ provider.name }} - {{ provider.specialty }}
          </ng-template>
        </app-dropdown>
      }

      <!-- Cliente -->
      <div class="form-field">
        <app-input
          label="CLIENTE"
          formControlName="customerSearch"
          placeholder="Buscar cliente..."
          [iconStart]="UserIcon"
          [iconSize]="18"
        />

        @if (showCustomerDropdown() && filteredCustomers().length > 0) {
          <div class="dropdown-results">
            @for (customer of filteredCustomers(); track customer.id) {
              <button type="button" class="dropdown-item" (click)="selectCustomer(customer)">
                <strong>{{ customer.name }}</strong>
                @if (customer.phone || customer.email) {
                  <span class="item-meta">{{ customer.phone || customer.email }}</span>
                }
              </button>
            }
          </div>
        }
      </div>

      <!-- Servicio -->
      <div class="form-field">
        <app-input
          label="SERVICIO"
          formControlName="serviceSearch"
          placeholder="Buscar servicio..."
          [iconStart]="BriefcaseIcon"
          [iconSize]="18"
        />

        @if (showServiceDropdown() && filteredServices().length > 0) {
          <div class="dropdown-results">
            @for (service of filteredServices(); track service.id) {
              <button type="button" class="dropdown-item" (click)="selectService(service)">
                <strong>{{ service.name }}</strong>
                <span class="item-meta">{{ service.defaultDuration }} min @if (service.price) {· ${{ service.price }}}</span>
              </button>
            }
          </div>
        }
      </div>

      <!-- Horarios con Time Range Picker -->
      <div class="form-field full-width">
        <app-time-range-picker
          [startTime]="appointmentForm.get('startTime')?.value || '09:00'"
          [endTime]="appointmentForm.get('endTime')?.value || '10:00'"
          [step]="15"
          (timeRangeChange)="onTimeRangeChange($event)">
        </app-time-range-picker>
      </div>

      <!-- Notas Internas -->
      <app-textarea
        label="NOTAS INTERNAS"
        formControlName="notes"
        [rows]="3"
        placeholder="Detalles adicionales..."
      />

      <!-- Alertas -->
      @if (errorMessage()) {
        <div class="alert alert-danger">
          {{ errorMessage() }}
        </div>
      }
      @if (successMessage()) {
        <div class="alert alert-success">
          {{ successMessage() }}
        </div>
      }

    </form>

    <!-- Footer -->
    <div class="modal-footer">
      <app-button
        label="Limpiar"
        severity="outlined"
        customClass="btn-text"
        (onClick)="appointmentForm.reset()"
      />
      <div class="footer-actions">
        <app-button
          label="Cancelar"
          severity="outlined"
          (onClick)="onCancel()"
        />
        <app-button
          type="submit"
          label="Crear Turno"
          severity="primary"
          [loading]="isSaving()"
          [disabled]="isSaving()"
          (onClick)="onSubmit()"
        />
      </div>
    </div>

    <!-- Loading -->
    @if (isLoading()) {
      <app-loading-spinner [overlay]="true" message="Cargando..." />
    }
  </app-card>
</div>
